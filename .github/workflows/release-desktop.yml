name: Build Desktop App

# åœ¨åˆ›å»º Release æ—¶è§¦å‘ï¼Œæˆ–æ‰‹åŠ¨è§¦å‘
on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 0.3.0)'
        required: false
        default: ''

# å–æ¶ˆåŒä¸€åˆ†æ”¯ä¸Šçš„æ—§æž„å»º
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.10'

jobs:
  # ============================================
  # Windows æž„å»º
  # ============================================
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            frontend/package-lock.json
            desktop/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install PyInstaller
        run: pip install pyinstaller

      # æž„å»ºå‰ç«¯
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      # æž„å»ºåŽç«¯
      - name: Install backend dependencies
        working-directory: backend
        run: uv sync

      - name: Package backend with PyInstaller
        run: pyinstaller desktop/banana-slides.spec --clean --noconfirm --distpath backend/dist --workpath backend/build

      # å¤åˆ¶æž„å»ºäº§ç‰©åˆ° desktop ç›®å½•
      - name: Copy build artifacts
        run: |
          if (Test-Path "desktop\frontend") { Remove-Item -Recurse -Force "desktop\frontend" }
          if (Test-Path "desktop\backend") { Remove-Item -Recurse -Force "desktop\backend" }
          Copy-Item -Recurse "frontend\dist" "desktop\frontend"
          Copy-Item -Recurse "backend\dist\banana-backend" "desktop\backend"
        shell: pwsh

      # æž„å»º Electron åº”ç”¨
      - name: Install desktop dependencies
        working-directory: desktop
        run: npm ci

      - name: Build Electron (Windows)
        working-directory: desktop
        run: npm run build:electron
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ä¸Šä¼ æž„å»ºäº§ç‰©
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: desktop/dist/*.exe
          if-no-files-found: error

      # ä¸Šä¼ åˆ° Release
      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: desktop/dist/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # macOS æž„å»º
  # ============================================
  build-macos:
    name: Build macOS Installer
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            frontend/package-lock.json
            desktop/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install PyInstaller
        run: pip install pyinstaller

      # ç”Ÿæˆ macOS å›¾æ ‡ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
      - name: Generate macOS icon
        run: |
          if [ ! -f "desktop/resources/icon.icns" ]; then
            echo "âš ï¸ icon.icns not found, attempting to generate from icon.png..."
            if [ -f "desktop/resources/icon.png" ]; then
              mkdir -p desktop/resources/icon.iconset
              # ç”Ÿæˆä¸åŒå°ºå¯¸çš„å›¾æ ‡
              sips -z 16 16     desktop/resources/icon.png --out desktop/resources/icon.iconset/icon_16x16.png
              sips -z 32 32     desktop/resources/icon.png --out desktop/resources/icon.iconset/icon_16x16@2x.png
              sips -z 32 32     desktop/resources/icon.png --out desktop/resources/icon.iconset/icon_32x32.png
              sips -z 64 64     desktop/resources/icon.png --out desktop/resources/icon.iconset/icon_32x32@2x.png
              sips -z 128 128   desktop/resources/icon.png --out desktop/resources/icon.iconset/icon_128x128.png
              sips -z 256 256   desktop/resources/icon.png --out desktop/resources/icon.iconset/icon_128x128@2x.png
              sips -z 256 256   desktop/resources/icon.png --out desktop/resources/icon.iconset/icon_256x256.png
              sips -z 512 512   desktop/resources/icon.png --out desktop/resources/icon.iconset/icon_256x256@2x.png
              sips -z 512 512   desktop/resources/icon.png --out desktop/resources/icon.iconset/icon_512x512.png
              sips -z 1024 1024 desktop/resources/icon.png --out desktop/resources/icon.iconset/icon_512x512@2x.png
              # è½¬æ¢ä¸º icns
              iconutil -c icns desktop/resources/icon.iconset -o desktop/resources/icon.icns
              rm -rf desktop/resources/icon.iconset
              echo "âœ… icon.icns generated successfully"
            else
              echo "âš ï¸ icon.png not found, skipping icon generation"
            fi
          else
            echo "âœ… icon.icns already exists"
          fi

      # æž„å»ºå‰ç«¯
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      # æž„å»ºåŽç«¯
      - name: Install backend dependencies
        working-directory: backend
        run: uv sync

      - name: Package backend with PyInstaller
        run: pyinstaller desktop/banana-slides.spec --clean --noconfirm --distpath backend/dist --workpath backend/build

      # å¤åˆ¶æž„å»ºäº§ç‰©åˆ° desktop ç›®å½•
      - name: Copy build artifacts
        run: |
          rm -rf desktop/frontend desktop/backend
          cp -r frontend/dist desktop/frontend
          cp -r backend/dist/banana-backend desktop/backend

      # æž„å»º Electron åº”ç”¨
      - name: Install desktop dependencies
        working-directory: desktop
        run: npm ci

      - name: Build Electron (macOS ${{ matrix.arch }})
        working-directory: desktop
        run: npx electron-builder --mac --${{ matrix.arch }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ä¸Šä¼ æž„å»ºäº§ç‰©
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer-${{ matrix.arch }}
          path: desktop/dist/*.dmg
          if-no-files-found: error

      # ä¸Šä¼ åˆ° Release
      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: desktop/dist/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================
  # æž„å»ºæ‘˜è¦
  # ============================================
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos]
    if: always()
    
    steps:
      - name: Check build results
        run: |
          echo "## ðŸŒ Banana Slides Desktop Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build-windows.result }}" == "success" ]; then
            echo "âœ… **Windows**: Build successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Windows**: Build failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.build-macos.result }}" == "success" ]; then
            echo "âœ… **macOS**: Build successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **macOS**: Build failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Artifacts are available in the Actions tab or attached to the Release." >> $GITHUB_STEP_SUMMARY
