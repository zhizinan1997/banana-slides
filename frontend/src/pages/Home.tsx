import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Sparkles, FileText, FileEdit } from 'lucide-react';
import { Button, Textarea, Card, useToast } from '@/components/shared';
import { TemplateSelector } from '@/components/shared/TemplateSelector';
import { useProjectStore } from '@/store/useProjectStore';

type CreationType = 'idea' | 'outline' | 'description';

export const Home: React.FC = () => {
  const navigate = useNavigate();
  const { initializeProject, isGlobalLoading } = useProjectStore();
  const { show, ToastContainer } = useToast();
  
  const [activeTab, setActiveTab] = useState<CreationType>('idea');
  const [content, setContent] = useState('');
  const [selectedTemplate, setSelectedTemplate] = useState<File | null>(null);
  const [selectedTemplateId, setSelectedTemplateId] = useState<string | null>(null);
  const [selectedPresetTemplateId, setSelectedPresetTemplateId] = useState<string | null>(null);

  const tabConfig = {
    idea: {
      icon: <Sparkles size={20} />,
      label: 'ä¸€å¥è¯ç”Ÿæˆ',
      placeholder: 'ä¾‹å¦‚ï¼šç”Ÿæˆä¸€ä»½å…³äº AI å‘å±•å²çš„æ¼”è®² PPT',
      description: 'è¾“å…¥ä½ çš„æƒ³æ³•ï¼ŒAI å°†ä¸ºä½ ç”Ÿæˆå®Œæ•´çš„ PPT',
    },
    outline: {
      icon: <FileText size={20} />,
      label: 'ä»å¤§çº²ç”Ÿæˆ',
      placeholder: 'ç²˜è´´ä½ çš„ PPT å¤§çº²...\n\nä¾‹å¦‚ï¼š\nç¬¬ä¸€éƒ¨åˆ†ï¼šAI çš„èµ·æº\n- 1950 å¹´ä»£çš„å¼€ç«¯\n- è¾¾ç‰¹èŒ…æ–¯ä¼šè®®\n\nç¬¬äºŒéƒ¨åˆ†ï¼šå‘å±•å†ç¨‹\n...',
      description: 'å·²æœ‰å¤§çº²ï¼Ÿç›´æ¥ç²˜è´´å³å¯å¿«é€Ÿç”Ÿæˆï¼ŒAI å°†è‡ªåŠ¨åˆ‡åˆ†ä¸ºç»“æ„åŒ–å¤§çº²',
    },
    description: {
      icon: <FileEdit size={20} />,
      label: 'ä»æè¿°ç”Ÿæˆ',
      placeholder: 'ç²˜è´´ä½ çš„å®Œæ•´é¡µé¢æè¿°...\n\nä¾‹å¦‚ï¼š\nç¬¬ 1 é¡µ\næ ‡é¢˜ï¼šäººå·¥æ™ºèƒ½çš„è¯ç”Ÿ\nå†…å®¹ï¼š1950 å¹´ï¼Œå›¾çµæå‡º"å›¾çµæµ‹è¯•"...\n\nç¬¬ 2 é¡µ\næ ‡é¢˜ï¼šAI çš„å‘å±•å†ç¨‹\nå†…å®¹ï¼š1950å¹´ä»£ï¼šç¬¦å·ä¸»ä¹‰...\n...',
      description: 'å·²æœ‰å®Œæ•´æè¿°ï¼ŸAI å°†è‡ªåŠ¨è§£æå‡ºå¤§çº²å¹¶åˆ‡åˆ†ä¸ºæ¯é¡µæè¿°ï¼Œç›´æ¥ç”Ÿæˆå›¾ç‰‡',
    },
  };

  const handleTemplateSelect = async (templateFile: File | null, templateId?: string) => {
    // æ€»æ˜¯è®¾ç½®æ–‡ä»¶ï¼ˆå¦‚æœæä¾›ï¼‰
    if (templateFile) {
      setSelectedTemplate(templateFile);
    }
    
    // å¤„ç†æ¨¡æ¿ ID
    if (templateId) {
      // åˆ¤æ–­æ˜¯ç”¨æˆ·æ¨¡æ¿è¿˜æ˜¯é¢„è®¾æ¨¡æ¿
      // é¢„è®¾æ¨¡æ¿ ID é€šå¸¸æ˜¯ '1', '2', '3' ç­‰çŸ­å­—ç¬¦ä¸²
      // ç”¨æˆ·æ¨¡æ¿ ID é€šå¸¸è¾ƒé•¿ï¼ˆUUID æ ¼å¼ï¼‰
      if (templateId.length <= 3 && /^\d+$/.test(templateId)) {
        // é¢„è®¾æ¨¡æ¿
        setSelectedPresetTemplateId(templateId);
        setSelectedTemplateId(null);
      } else {
        // ç”¨æˆ·æ¨¡æ¿
        setSelectedTemplateId(templateId);
        setSelectedPresetTemplateId(null);
      }
    } else {
      // å¦‚æœæ²¡æœ‰ templateIdï¼Œå¯èƒ½æ˜¯ç›´æ¥ä¸Šä¼ çš„æ–‡ä»¶
      // æ¸…ç©ºæ‰€æœ‰é€‰æ‹©çŠ¶æ€
      setSelectedTemplateId(null);
      setSelectedPresetTemplateId(null);
    }
  };

  const handleSubmit = async () => {
    if (!content.trim()) {
      show({ message: 'è¯·è¾“å…¥å†…å®¹', type: 'error' });
      return;
    }

    try {
      // TemplateSelector å·²ç»å¤„ç†äº†æ¨¡æ¿é€‰æ‹©ï¼ŒselectedTemplate åº”è¯¥å·²ç»åŒ…å«æ–‡ä»¶
      await initializeProject(activeTab, content, selectedTemplate || undefined);
      
      // æ ¹æ®ç±»å‹è·³è½¬åˆ°ä¸åŒé¡µé¢
      const projectId = localStorage.getItem('currentProjectId');
      if (!projectId) {
        show({ message: 'é¡¹ç›®åˆ›å»ºå¤±è´¥', type: 'error' });
        return;
      }
      
      if (activeTab === 'idea' || activeTab === 'outline') {
        navigate(`/project/${projectId}/outline`);
      } else if (activeTab === 'description') {
        // ä»æè¿°ç”Ÿæˆï¼šç›´æ¥è·³åˆ°æè¿°ç”Ÿæˆé¡µï¼ˆå› ä¸ºå·²ç»è‡ªåŠ¨ç”Ÿæˆäº†å¤§çº²å’Œæè¿°ï¼‰
        navigate(`/project/${projectId}/detail`);
      }
    } catch (error: any) {
      console.error('åˆ›å»ºé¡¹ç›®å¤±è´¥:', error);
      // é”™è¯¯å·²ç»åœ¨ store ä¸­å¤„ç†å¹¶æ˜¾ç¤º
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-banana-50 via-white to-gray-50">
      {/* å¯¼èˆªæ  */}
      <nav className="h-16 bg-white shadow-sm border-b border-gray-100">
        <div className="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
          <div className="flex items-center gap-2">
            <img
              src="/logo.jpg"
              alt="è•‰å¹» Banana Slides Logo"
              className="w-12 h-12 rounded-lg object-cover object-center"
            />
            <span className="text-xl font-bold text-gray-900">è•‰å¹»</span>
          </div>
          <div className="flex items-center gap-4">
            <Button variant="ghost" size="sm" onClick={() => navigate('/history')}>
              å†å²é¡¹ç›®
            </Button>
            <Button variant="ghost" size="sm">å¸®åŠ©</Button>
          </div>
        </div>
      </nav>

      {/* ä¸»å†…å®¹ */}
      <main className="max-w-4xl mx-auto px-4 py-16">
        {/* æ ‡é¢˜åŒº */}
        <div className="text-center mb-12">
          <h1 className="text-5xl font-bold text-gray-900 mb-4">
            ğŸŒ è•‰å¹» Banana Slides
          </h1>
          <p className="text-xl text-gray-600">
            AI åŸç”Ÿ PPT ç”Ÿæˆå™¨ï¼Œä¸€å¥è¯åˆ›é€ ç²¾å½©
          </p>
        </div>

        {/* åˆ›å»ºå¡ç‰‡ */}
        <Card className="p-10">
          {/* é€‰é¡¹å¡ */}
          <div className="flex gap-4 mb-8">
            {(Object.keys(tabConfig) as CreationType[]).map((type) => {
              const config = tabConfig[type];
              return (
                <button
                  key={type}
                  onClick={() => setActiveTab(type)}
                  className={`flex-1 flex items-center justify-center gap-2 px-6 py-3 rounded-lg font-medium transition-all ${
                    activeTab === type
                      ? 'bg-gradient-to-r from-banana-500 to-banana-600 text-black shadow-yellow'
                      : 'bg-white border border-gray-200 text-gray-700 hover:bg-banana-50'
                  }`}
                >
                  {config.icon}
                  {config.label}
                </button>
              );
            })}
          </div>

          {/* æè¿° */}
          <p className="text-gray-600 mb-6">
            {tabConfig[activeTab].description}
          </p>

          {/* è¾“å…¥åŒº */}
          <Textarea
            placeholder={tabConfig[activeTab].placeholder}
            value={content}
            onChange={(e) => setContent(e.target.value)}
            rows={activeTab === 'idea' ? 4 : 10}
            className="mb-6"
          />

          {/* æ¨¡æ¿é€‰æ‹© */}
          <div className="mb-8">
            <h3 className="text-lg font-semibold text-gray-900 mb-4">
              ğŸ¨ é€‰æ‹©é£æ ¼æ¨¡æ¿
            </h3>
            <TemplateSelector
              onSelect={handleTemplateSelect}
              selectedTemplateId={selectedTemplateId}
              selectedPresetTemplateId={selectedPresetTemplateId}
              showUpload={true} // åœ¨ä¸»é¡µä¸Šä¼ çš„æ¨¡æ¿ä¿å­˜åˆ°ç”¨æˆ·æ¨¡æ¿åº“
            />
          </div>

          {/* æäº¤æŒ‰é’® */}
          <div className="flex justify-center">
            <Button
              size="lg"
              onClick={handleSubmit}
              loading={isGlobalLoading}
              className="w-64"
            >
              å¼€å§‹ç”Ÿæˆ
            </Button>
          </div>
        </Card>
      </main>
      <ToastContainer />
    </div>
  );
};

